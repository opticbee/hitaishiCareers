<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 260px; background-color: #fff; border-right: 1px solid #dee2e6; padding: 1.5rem; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-header .logo { font-size: 1.8rem; font-weight: 700; color: #0d6efd; }
        .sidebar-header .company-name { font-weight: 600; color: #343a40; }
        .nav-buttons .nav-btn { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1rem; border-radius: 0.5rem; color: #495057; font-weight: 500; transition: all 0.2s ease; }
        .nav-buttons .nav-btn i { font-size: 1.1rem; width: 20px; }
        .nav-buttons .nav-btn:hover, .nav-buttons .nav-btn.active { background-color: #e9ecef; color: #0d6efd; }
        .main-content { margin-left: 260px; padding: 2rem; }
        .content-section { display: none; animation: fadeIn 0.4s ease-out; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card { border: none; border-radius: 0.75rem; box-shadow: 0 2px G(0, 0, 0, 0.07); }
        .placeholder-text { color: #6c757d; text-align: center; padding: 3rem; }
        input:read-only { background-color: #e9ecef; cursor: not-allowed; }
        
        /* Toast Notification Styles */
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 1055; display: flex; flex-direction: column; gap: 10px; }
        .toast-notification { padding: 1rem 1.5rem; border-radius: 0.5rem; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 1rem; opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast-notification.success { background-color: #28a745; }
        .toast-notification.error { background-color: #dc3545; }
        .toast-notification.warning { background-color: #ffc107; color: #212529;}
        .toast-notification i { font-size: 1.2rem; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%);} }
    </style>
</head>
<body>
    <div id="toastContainer"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header text-center mb-5">
            <div class="logo mb-3">WinJob</div>
            <img id="sidebarLogo" src="https://placehold.co/80x80/EFEFEF/AAAAAA&text=Logo" alt="Logo" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover; margin: 0 auto;">
            <div class="company-name mt-2" id="sidebarCompanyName">Loading...</div>
        </div>
        <div class="nav-buttons d-flex flex-column gap-2 flex-grow-1">
            <button class="nav-btn active" data-section="postJobSection"><i class="fas fa-plus-circle"></i><span>Post a Job</span></button>
            <button class="nav-btn" data-section="myJobsSection"><i class="fas fa-briefcase"></i><span>My Jobs</span></button>
            <button class="nav-btn" data-section="updateProfileSection"><i class="fas fa-user-edit"></i><span>Update Profile</span></button>
        </div>
        <div class="mt-auto">
            <button class="nav-btn w-100" id="logoutButton"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
        </div>
    </div>

    <main class="main-content">
        <section id="postJobSection" class="content-section active">
            <div class="card">
                <div class="card-header bg-white py-3"><h5 class="mb-0">Post a New Job Opening</h5></div>
                <div class="card-body p-4">
                    <form id="postJobForm">
                         <div class="row g-3">
                            <div class="col-md-6"><label for="jobTitle" class="form-label">Job Title</label><input type="text" class="form-control" id="jobTitle" required></div>
                            <div class="col-md-6"><label for="requiredExperience" class="form-label">Required Experience (e.g., 2+ Years)</label><input type="text" class="form-control" id="requiredExperience"></div>
                            
                            <!-- New Salary Fields -->
                            <div class="col-md-3"><label for="salaryMin" class="form-label">Salary Minimum</label><input type="number" class="form-control" id="salaryMin" placeholder="e.g., 80000"></div>
                            <div class="col-md-3"><label for="salaryMax" class="form-label">Salary Maximum</label><input type="number" class="form-control" id="salaryMax" placeholder="e.g., 120000"></div>
                            <div class="col-md-3">
                                <label for="salaryCurrency" class="form-label">Currency</label>
                                <select id="salaryCurrency" class="form-select">
                                    <option value="INR">₹ INR</option>
                                    <option value="USD">$ USD</option>
                                    <option value="EUR">€ EUR</option>
                                    <option value="GBP">£ GBP</option>
                                    <option value="AED">د.إ AED</option>
                                    <option value="CAD">C$ CAD</option>
                                    <option value="AUD">A$ AUD</option>
                                </select>
                            </div>
                             <div class="col-md-3">
                                <label for="salaryPeriod" class="form-label">Period</label>
                                <select id="salaryPeriod" class="form-select">
                                    <option value="Per Year">Per Year</option>
                                    <option value="Per Month">Per Month</option>
                                </select>
                            </div>

                            <hr class="my-3">

                            <div class="col-md-6"><label for="postedByName" class="form-label">Hiring Manager / Contact Person</label><input type="text" class="form-control" id="postedByName" required></div>
                            <div class="col-md-6"><label for="postedByEmail" class="form-label">Contact Email</label><input type="email" class="form-control" id="postedByEmail" required></div>
                            <div class="col-md-4"><label for="country" class="form-label">Country</label><input type="text" class="form-control" id="country"></div>
                            <div class="col-md-4"><label for="state" class="form-label">State</label><input type="text" class="form-control" id="state"></div>
                            <div class="col-md-4"><label for="city" class="form-label">City</label><input type="text" class="form-control" id="city"></div>
                            <div class="col-12"><label for="jobDescription" class="form-label">Job Description</label><textarea class="form-control" id="jobDescription" rows="5" required></textarea></div>
                            <div class="col-12"><label for="requiredSkills" class="form-label">Required Skills (comma-separated)</label><input type="text" class="form-control" id="requiredSkills" placeholder="e.g., JavaScript, React, Node.js" required></div>
                         </div>
                        <div class="mt-4 text-end"><button type="submit" class="btn btn-primary px-4">Post Job</button></div>
                    </form>
                </div>
            </div>
        </section>

        <section id="myJobsSection" class="content-section">
            <h3 class="mb-4">My Posted Jobs</h3>
            <div id="jobsContainer"><p class="placeholder-text">Loading jobs...</p></div>
        </section>

        <section id="updateProfileSection" class="content-section">
            <div class="card">
                <div class="card-header bg-white py-3"><h5 class="mb-0">Update Company Profile</h5></div>
                <div class="card-body p-4">
                    <form id="updateProfileForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Company Logo</label>
                                <div class="d-flex align-items-center">
                                    <img id="logoPreview" src="https://placehold.co/100x100/EFEFEF/AAAAAA&text=Logo" alt="Company Logo" class="me-3 rounded" style="width: 100px; height: 100px; object-fit: cover;">
                                    <input type="file" class="form-control" id="companyLogo" accept="image/*">
                                </div>
                            </div>
                            <div class="col-md-6"><label for="companyName" class="form-label">Company Name</label><input type="text" class="form-control" id="companyName" required></div>
                            <div class="col-md-6"><label for="companyWebsite" class="form-label">Website</label><input type="url" class="form-control" id="companyWebsite"></div>
                            <div class="col-md-6"><label for="companyEmail" class="form-label">Email</label><input type="email" class="form-control" id="companyEmail" required readonly></div>
                            <div class="col-md-6"><label for="personName" class="form-label">Person Name</label><input type="text" class="form-control" id="personName"></div>
                            <div class="col-md-6"><label for="phoneNumber" class="form-label">Phone Number</label><input type="tel" class="form-control" id="phoneNumber"></div>
                            <div class="col-md-6"><label for="address" class="form-label">Address</label><input type="text" class="form-control" id="address"></div>
                            <div class="col-12"><label for="companyDescription" class="form-label">Description</label><textarea class="form-control" id="companyDescription" rows="4"></textarea></div>
                        </div>
                        <div class="mt-4 text-end"><button type="submit" class="btn btn-primary px-4">Save Changes</button></div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const token = sessionStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'employerlogin.html';
                return;
            }

            let currentCompanyProfile = null; // Variable to store company profile

            // --- Toast Notification ---
            const toastContainer = document.getElementById('toastContainer');
            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast-notification ${type}`;
                let iconClass = 'fas fa-check-circle';
                if (type === 'error') iconClass = 'fas fa-times-circle';
                if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
                toast.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 5000);
            };

            // --- API Fetch Helper ---
            const fetchData = async (url, options = {}) => {
                try {
                    const defaultHeaders = { 'Authorization': `Bearer ${token}` };
                    // Only add Content-Type for JSON, not for FormData
                    if (!(options.body instanceof FormData)) {
                        defaultHeaders['Content-Type'] = 'application/json';
                    }

                    const response = await fetch(url, {
                        ...options,
                        headers: { ...defaultHeaders, ...options.headers },
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            showToast('Session expired. Please log in again.', 'error');
                            sessionStorage.removeItem('authToken');
                            window.location.href = 'employerlogin.html';
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Error: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('API call failed:', error);
                    showToast(error.message, 'error');
                    return null;
                }
            };

            const fetchCompanyProfile = async () => {
                const profile = await fetchData(`/api/company/profile`);
                if (profile) {
                    currentCompanyProfile = profile; // Store the profile
                    renderCompanyProfile(profile);
                }
            };

            const fetchJobs = async () => {
                if (!currentCompanyProfile || !currentCompanyProfile.id) {
                    console.log("Company profile not loaded yet, can't fetch jobs.");
                    return;
                }
                const data = await fetchData(`/api/jobs/company/${currentCompanyProfile.id}`); 
                if (data && data.jobs) {
                    renderJobs(data.jobs);
                } else {
                    document.getElementById('jobsContainer').innerHTML = '<p class="placeholder-text">Could not load jobs, or you have not posted any yet.</p>';
                }
            };

            const renderCompanyProfile = (profile) => {
                document.getElementById('sidebarCompanyName').textContent = profile.company_name;

                const timestamp = '?t=' + new Date().getTime();
                const placeholderLogo = 'https://placehold.co/100x100/EFEFEF/AAAAAA&text=Logo';
                const placeholderSidebarLogo = 'https://placehold.co/80x80/EFEFEF/AAAAAA&text=Logo';

                const sidebarLogo = document.getElementById('sidebarLogo');
                sidebarLogo.src = profile.logo_url ? profile.logo_url + timestamp : placeholderSidebarLogo;
                sidebarLogo.onerror = () => { sidebarLogo.src = placeholderSidebarLogo; };

                const logoPreview = document.getElementById('logoPreview');
                logoPreview.src = profile.logo_url ? profile.logo_url + timestamp : placeholderLogo;
                logoPreview.onerror = () => { logoPreview.src = placeholderLogo; };

                document.getElementById('companyName').value = profile.company_name || '';
                document.getElementById('companyWebsite').value = profile.website || '';
                document.getElementById('companyEmail').value = profile.user_email || '';
                document.getElementById('personName').value = profile.contact_person || '';
                document.getElementById('phoneNumber').value = profile.contact_phone || '';
                document.getElementById('address').value = profile.address || '';
                document.getElementById('companyDescription').value = profile.description || '';
                
                // Pre-fill job contact details from company profile
                document.getElementById('postedByName').value = profile.contact_person || '';
                document.getElementById('postedByEmail').value = profile.user_email || '';
            };

            const renderJobs = (jobs) => {
                const container = document.getElementById('jobsContainer');
                if (jobs.length === 0) {
                    container.innerHTML = '<p class="placeholder-text">You have not posted any jobs yet.</p>';
                    return;
                }
                container.innerHTML = jobs.map(job => {
                    let salaryInfo = '';
                    if (job.salary_min && job.salary_max && job.salary_currency && job.salary_period) {
                        salaryInfo = `
                        <div class="text-success fw-bold mt-1">
                            <small>${job.salary_currency} ${job.salary_min.toLocaleString()} - ${job.salary_max.toLocaleString()} ${job.salary_period}</small>
                        </div>`;
                    }

                    return `
                    <div class="card mb-3">
                        <div class="card-body">
                           <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title mb-1">${job.job_title}</h5>
                                    <h6 class="card-subtitle text-muted"><i class="fas fa-map-marker-alt fa-fw me-1"></i>${job.city || 'Remote'}, ${job.country || ''}</h6>
                                    ${salaryInfo}
                                </div>
                                <span class="badge bg-${job.status === 'active' ? 'success' : 'secondary'}">${job.status}</span>
                           </div>
                        </div>
                    </div>
                `}).join('');
            };
            
            document.getElementById('companyLogo').addEventListener('change', function() {
                if (this.files[0]) {
                    document.getElementById('logoPreview').src = URL.createObjectURL(this.files[0]);
                }
            });

            document.getElementById('companyEmail').addEventListener('click', () => {
                showToast('Email address cannot be modified.', 'warning');
            });

            document.getElementById('postJobForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const jobData = {
                    job_title: document.getElementById('jobTitle').value,
                    required_experience: document.getElementById('requiredExperience').value,
                    salary_min: document.getElementById('salaryMin').value || null,
                    salary_max: document.getElementById('salaryMax').value || null,
                    salary_currency: document.getElementById('salaryCurrency').value,
                    salary_period: document.getElementById('salaryPeriod').value,
                    posted_by_name: document.getElementById('postedByName').value,
                    posted_by_email: document.getElementById('postedByEmail').value,
                    country: document.getElementById('country').value,
                    state: document.getElementById('state').value,
                    city: document.getElementById('city').value,
                    job_description: document.getElementById('jobDescription').value,
                    required_skills: document.getElementById('requiredSkills').value,
                };
                const result = await fetchData('/api/jobs/post', { method: 'POST', body: JSON.stringify(jobData) });
                if (result && result.success) {
                    showToast('Job posted successfully!');
                    e.target.reset();
                    // Pre-fill contact details again after reset
                    document.getElementById('postedByName').value = currentCompanyProfile.contact_person || '';
                    document.getElementById('postedByEmail').value = currentCompanyProfile.user_email || '';
                    fetchJobs(); 
                }
            });

            document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData();
                formData.append('company_name', document.getElementById('companyName').value);
                formData.append('website', document.getElementById('companyWebsite').value);
                formData.append('contact_person', document.getElementById('personName').value);
                formData.append('contact_phone', document.getElementById('phoneNumber').value);
                formData.append('address', document.getElementById('address').value);
                formData.append('description', document.getElementById('companyDescription').value);
                const logoFile = document.getElementById('companyLogo').files[0];
                if (logoFile) { formData.append('logo', logoFile); }

                const result = await fetchData(`/api/company/profile`, { method: 'PATCH', body: formData });
                if (result && result.success) {
                    showToast(result.message || 'Profile updated successfully!');
                    if (result.profile) {
                        currentCompanyProfile = result.profile; // Update stored profile
                        renderCompanyProfile(result.profile);
                    } else {
                        fetchCompanyProfile(); // Fallback to refetch
                    }
                }
            });

            // --- Navigation Logic ---
            const navButtons = document.querySelectorAll('.nav-btn[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            const showSection = (sectionId) => {
                navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.section === sectionId));
                contentSections.forEach(section => section.classList.toggle('active', section.id === sectionId));
            };
            navButtons.forEach(button => {
                button.addEventListener('click', () => showSection(button.dataset.section));
            });

            // --- Logout ---
            document.getElementById('logoutButton').addEventListener('click', () => {
                sessionStorage.removeItem('authToken');
                window.location.href = 'employerlogin.html';
            });

            // --- Initialize Dashboard ---
            const initializeDashboard = async () => {
                await fetchCompanyProfile(); // Wait for profile to load first
                fetchJobs(); // Then fetch jobs using the loaded profile ID
            };
            initializeDashboard();
        });
    </script>
</body>
</html>

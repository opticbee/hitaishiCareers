<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Job</title>
    <!-- Favicon, Bootstrap, Font Awesome, Google Fonts -->
    <link rel="icon" href="https://winjob.in/images/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f4f7fc;
            font-family: 'Poppins', sans-serif;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: none;
        }
        .job-header {
            border-bottom: 1px solid #e9ecef;
        }
        .company-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #0d6efd;
            display: inline-block;
        }
        .user-profile-card .list-group-item {
            border: none;
            padding: 0.75rem 0;
        }
        .detail-item {
            display: flex;
            margin-bottom: 0.75rem;
        }
        .detail-item .icon {
            font-size: 1rem;
            color: #0d6efd;
            width: 25px;
            text-align: center;
        }
        .detail-item .text {
            font-weight: 500;
            color: #495057;
        }
        #applyBtn {
            font-size: 1.1rem;
            padding: 0.75rem;
        }
        .skill-badge {
            font-size: 0.8rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-2">
        <div class="container">
          <a class="navbar-brand d-flex align-items-center" href="index.html">
            <img src="images/logo.png" alt="Hitaishi Careers Logo" height="40" class="me-2">
            <span class="fw-bold">Hitaishi Careers</span>
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
              <li class="nav-item"><a class="nav-link" href="jobs.html">Jobs</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="container py-5">
        <div id="page-content">
            <!-- Loading Spinner -->
            <div class="text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div></div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const pageContent = document.getElementById('page-content');
            
            // --- Helper Functions ---
            const renderError = (message, showLoginButton = false) => {
                let buttonHtml = showLoginButton ? `<a href="login.html" class="btn btn-primary mt-3">Go to Login</a>` : '';
                pageContent.innerHTML = `
                    <div class="card p-5 text-center">
                        <h3 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error</h3>
                        <p class="text-muted fs-5">${message}</p>
                        ${buttonHtml}
                    </div>
                `;
            };

            const formatSalary = (job) => {
                if (job.salary_min && job.salary_max) {
                    return `${job.salary_currency} ${job.salary_min.toLocaleString()} - ${job.salary_max.toLocaleString()} per ${job.salary_period || 'annum'}`;
                }
                return 'Not Disclosed';
            };

            const formatSkills = (skills, title) => {
                 const skillArray = skills && typeof skills === 'string' ? JSON.parse(skills) : skills;
                if (!Array.isArray(skillArray) || skillArray.length === 0) return '';
                return `
                    <h3 class="section-title mt-4">${title}</h3>
                    <div>
                        ${skillArray.map(skill => `<span class="badge bg-secondary skill-badge me-1 mb-1">${skill}</span>`).join('')}
                    </div>
                `;
            };

            const getProfessionalSummary = (details) => {
                if(!details || details.length === 0) return 'No professional details provided.';
                const latest = details[0]; // Assuming the first is the most recent
                return `${latest.designation} at ${latest.company} with ${details.totalExperience || 'N/A'} of experience.`;
            }

            // --- Page Rendering Function ---
            function renderApplicationPage(job, user) {
                const { personalDetails, professionalDetails, resume } = user;
                const fullLocation = [job.city, job.state, job.country, job.zip_code].filter(Boolean).join(', ');

                pageContent.innerHTML = `
                    <div class="row g-4">
                        <!-- Left Column: Job Details -->
                        <div class="col-lg-7">
                            <div class="card">
                                <div class="card-body p-4">
                                    <div class="job-header d-flex align-items-center mb-4 pb-4">
                                        <img src="${job.logo_url || 'https://placehold.co/80x80/EFEFEF/AAAAAA&text=Logo'}" alt="${job.company_name} Logo" class="company-logo me-3">
                                        <div>
                                            <h2 class="h4 mb-1">${job.job_title}</h2>
                                            <p class="text-muted mb-0">${job.company_name}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="detail-item"><div class="icon"><i class="fas fa-map-marker-alt"></i></div><span class="text">${fullLocation}</span></div>
                                        <div class="detail-item"><div class="icon"><i class="fas fa-money-bill-wave"></i></div><span class="text">${formatSalary(job)}</span></div>
                                        <div class="detail-item"><div class="icon"><i class="fas fa-briefcase"></i></div><span class="text">${job.job_type || 'N/A'}</span></div>
                                        <div class="detail-item"><div class="icon"><i class="fas fa-laptop-house"></i></div><span class="text">${job.work_location || 'N/A'}</span></div>
                                        <div class="detail-item"><div class="icon"><i class="fas fa-chart-line"></i></div><span class="text">${job.required_experience || 'N/A'}</span></div>
                                    </div>

                                    <h3 class="section-title">Job Description</h3>
                                    <p>${job.job_description ? job.job_description.replace(/\n/g, '<br>') : 'No description provided.'}</p>

                                    ${job.responsibilities ? `<h3 class="section-title mt-4">Responsibilities</h3><p>${job.responsibilities.replace(/\n/g, '<br>')}</p>` : ''}
                                    
                                    ${formatSkills(job.required_skills, 'Required Skills')}
                                    ${formatSkills(job.additional_skills, 'Additional Skills')}

                                </div>
                            </div>
                        </div>

                        <!-- Right Column: User Summary & Apply Button -->
                        <div class="col-lg-5">
                            <div class="card user-profile-card position-sticky" style="top: 20px;">
                                <div class="card-body p-4">
                                    <h3 class="section-title">Your Application</h3>
                                    <div class="d-flex align-items-center mb-3">
                                        <img src="${personalDetails.profilePhoto || 'https://placehold.co/60x60/0d6efd/ffffff&text=You'}" class="rounded-circle me-3" width="60" height="60">
                                        <div>
                                            <h5 class="mb-0">${personalDetails.fullName || 'N/A'}</h5>
                                            <p class="text-muted mb-0">${personalDetails.email || 'N/A'}</p>
                                        </div>
                                    </div>
                                    <ul class="list-group list-group-flush mb-3">
                                        <li class="list-group-item"><strong>Phone:</strong> ${personalDetails.phone || 'N/A'}</li>
                                        <li class="list-group-item"><strong>Professional Summary:</strong> ${getProfessionalSummary(professionalDetails)}</li>
                                        ${resume ? `<li class="list-group-item"><strong>Resume:</strong> <a href="${resume.url}" target="_blank">${resume.name} <i class="fas fa-external-link-alt fa-xs"></i></a></li>` : '<li class="list-group-item text-warning"><strong>Resume:</strong> Not Uploaded</li>'}
                                    </ul>

                                    <div id="apply-section">
                                        <p class="text-muted small">By clicking "Confirm & Apply", your full profile will be sent to the employer.</p>
                                        <div class="d-grid">
                                            <button id="applyBtn" class="btn btn-primary btn-lg">
                                                <i class="fas fa-paper-plane me-2"></i>Confirm & Apply
                                            </button>
                                        </div>
                                        <div id="apply-message" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('applyBtn').addEventListener('click', handleApply);
            }

            // --- Apply Logic ---
            async function handleApply() {
                const applyBtn = document.getElementById('applyBtn');
                const applyMessage = document.getElementById('apply-message');
                const urlParams = new URLSearchParams(window.location.search);
                const jobId = urlParams.get('jobId');

                applyBtn.disabled = true;
                applyBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Applying...`;
                
                try {
                    const response = await fetch('/api/applicant/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ jobId })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'An unknown error occurred.');

                    document.getElementById('apply-section').innerHTML = `
                        <div class="alert alert-success text-center">
                            <h4><i class="fas fa-check-circle"></i> Applied Successfully!</h4>
                            <p class="mb-0">The employer has received your application.</p>
                        </div>
                    `;
                } catch (error) {
                    applyMessage.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                    applyBtn.disabled = false;
                    applyBtn.innerHTML = `<i class="fas fa-paper-plane me-2"></i>Confirm & Apply`;
                }
            }

            // --- Initial Page Load Logic ---
            const userEmail = sessionStorage.getItem('email');
            if (!userEmail) {
                renderError("Please login to continue.", true);
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('jobId');
            if (!jobId) {
                renderError("No job specified. Go back and select a job.");
                return;
            }

            try {
                const [jobRes, userRes] = await Promise.all([
                    fetch(`/api/jobs/${jobId}`),
                    fetch(`/api/profile/full?email=${encodeURIComponent(userEmail)}`)
                ]);

                if (!jobRes.ok) throw new Error('Job not found or could not be loaded.');
                if (!userRes.ok) throw new Error('Could not load your user profile.');

                const { job } = await jobRes.json();
                const user = await userRes.json();
                
                renderApplicationPage(job, user);

            } catch (error) {
                renderError(error.message);
            }
        });
    </script>

    <!-- Footer -->
    <footer class="text-white py-5">
        <div class="container">
        <div class="row g-4">
            <div class="col-lg-4 col-md-6">
            <div class="mb-4">
                <img src="images/logo.png" alt="Hitaishi Careers Logo" height="40" class="me-2">
                <span class="fw-bold fs-4">Hitaishi Careers</span>
            </div>
            <p class="mb-4">Connecting talented professionals with their dream jobs since 2022. Our mission is to make job searching efficient and effective for everyone.</p>
            <div class="d-flex gap-3">
                <a href="#" class="text-white"><i class="fab fa-facebook-f fa-lg"></i></a>
                <a href="#" class="text-white"><i class="fab fa-twitter fa-lg"></i></a>
                <a href="#" class="text-white"><i class="fab fa-linkedin-in fa-lg"></i></a>
                <a href="#" class="text-white"><i class="fab fa-instagram fa-lg"></i></a>
            </div>
            </div>
            
            <div class="col-lg-2 col-md-6">
            <h5 class="mb-4">Quick Links</h5>
            <ul class="list-unstyled">
                <li class="mb-2"><a href="index.html" class="text-white-50">Home</a></li>
                <li class="mb-2"><a href="jobs.html" class="text-white-50">Browse Jobs</a></li>
                <li class="mb-2"><a href="employer.html" class="text-white-50">For Employers</a></li>
                <li class="mb-2"><a href="about.html" class="text-white-50">About Us</a></li>
                <li class="mb-2"><a href="contact.html" class="text-white-50">Contact</a></li>
            </ul>
            </div>
            
            <div class="col-lg-3 col-md-6">
            <h5 class="mb-4">Job Seeker Resources</h5>
            <ul class="list-unstyled">
                <li class="mb-2"><a href="resumebuild.html" class="text-white-50">Resume Builder</a></li>
                <li class="mb-2"><a href="preparation.html" class="text-white-50">Interview Tips</a></li>
                <li class="mb-2"><a href="careerbooster.html" class="text-white-50">Career Advice</a></li>
                <li class="mb-2"><a href="featuredprofile.html" class="text-white-50">Featured Profile</a></li>
                <li class="mb-2"><a href="tutu.html" class="text-white-50">Apply with AI</a></li>
            </ul>
            </div>
            
            <div class="col-lg-3 col-md-6">
            <h5 class="mb-4">Contact Us</h5>
            <ul class="list-unstyled">
                <li class="mb-3 d-flex align-items-start">
                <i class="fas fa-map-marker-alt me-3 mt-1"></i>
                <span class="text-white-50">985 pragathi nagar, Pragathi Nagar, Hyderabad, TS 500090</span>
                </li>
                <li class="mb-3 d-flex align-items-center">
                <i class="fas fa-phone me-3"></i>
                <a href="tel:+919876543210" class="text-white-50">+91 99087 93602</a>,  
                <a href="tel:+919876543210" class="text-white-50">+91 87901 70525</a>
                </li>
                <li class="mb-3 d-flex align-items-center">
                <i class="fas fa-envelope me-3"></i>
                <a href="mailto:info@hitashicareers.com" class="text-white-50">info@hitashicareers.com</a>
                </li>
            </ul>
            </div>
        </div>
        
        <hr class="my-5">
        
        <div class="row align-items-center">
            <div class="col-md-6 text-center text-md-start">
            <p class="mb-0">&copy; 2025 Hitaishi Careers. All rights reserved.</p>
            </div>
            <div class="col-md-6 text-center text-md-end">
            <a href="PrivacyPolicy.html" class="text-white-50 me-3">Privacy Policy</a>
            <a href="Terms-Conditions.html" class="text-white-50 me-3">Terms of Service</a>
            <a href="cookiesPolicy.html" class="text-white-50">Cookie Policy</a>
            </div>
        </div>
        </div>
        <style>
            footer {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }
        
        footer a {
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        footer a:hover {
            color: var(--secondary-color) !important;
        }
        </style>
    </footer>
    
</body>
</html>


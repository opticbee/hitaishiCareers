<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Portal - Profile</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="navbar.css">
    <!-- Font Awesome for additional icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="https://winjob.in/images/favicon.ico" type="image/x-icon">
    <style>
        :root {
            --primary-color: #0d6efd;
            --primary-hover: #0b5ed7;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
            --success-color: #198754;
            --success-hover: #157347;
            --danger-color: #dc3545;
            --danger-hover: #bb2d3b;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --card-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            --card-shadow-hover: 0 1rem 2rem rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            --border-radius: 0.75rem;
            --gradient-primary: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            --gradient-secondary: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            --gradient-success: linear-gradient(135deg, #198754 0%, #146c43 100%);
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 80px;
        }
        
        .card {
            border: none;
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-5px);
        }
        
        .card-header {
            background: var(--gradient-primary);
            color: white;
            border-bottom: none;
            padding: 1.5rem 1.5rem;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
        }
        
        .profile-photo-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }
        
        .profile-photo-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.3);
        }
        
        .dynamic-section, .view-section {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            background-color: #fff;
            transition: var(--transition);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        }
        
        .dynamic-section:hover, .view-section:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }
        
        .remove-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            opacity: 0.7;
            transition: var(--transition);
            background: rgba(220, 53, 69, 0.1);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-btn:hover {
            opacity: 1;
            background: rgba(220, 53, 69, 0.2);
            transform: scale(1.1);
        }
        
        .skill-rating {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .skill-rating input {
            flex: 1;
        }
        
        .resume-preview {
            background-color: #e9ecef;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .resume-preview:hover {
            background-color: #dee2e6;
            transform: translateX(5px);
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #e9ecef;
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            margin: 0.25rem;
            font-size: 0.875rem;
            border: 1px solid #ced4da;
            transition: var(--transition);
        }
        
        .tag:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        }
        
        .tag .bi-x {
            cursor: pointer;
            margin-left: 0.5rem;
            opacity: 0.7;
            transition: var(--transition);
        }
        
        .tag .bi-x:hover {
            opacity: 1;
            transform: scale(1.2);
        }
        
        .nav-link {
            color: var(--secondary-color);
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            transition: var(--transition);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover {
            background: rgba(13, 110, 253, 0.1);
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: var(--gradient-primary);
            color: white !important;
            box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.3);
        }
        
        .section-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-content.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .action-buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }
        
        .view-section h5 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.4em 0.8em;
            border-radius: 50px;
        }
        
        .btn {
            border-radius: 0.75rem;
            padding: 0.5rem 1.25rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            border: none;
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.3);
        }
        
        .btn-success {
            background: var(--gradient-success);
            border: none;
        }
        
        .btn-success:hover {
            background: var(--success-hover);
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(25, 135, 84, 0.3);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.3);
        }
        
        .form-control, .form-select {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            transform: translateY(-2px);
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
            margin-top: 5px;
        }
        
        .progress-bar {
            border-radius: 10px;
        }
        
        .rating-stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .rating-star {
            color: #ddd;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .rating-star.active {
            color: #ffc107;
        }
        
        .rating-star:hover {
            transform: scale(1.2);
        }
        
        @media (max-width: 991px) {
            .nav-pills {
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
                flex-wrap: nowrap;
                padding-bottom: 10px;
            }
            
            .nav-pills .nav-link {
                display: inline-block;
                width: auto;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Enhanced Education Section Styles */
        .education-entry {
            position: relative;
        }
        
        .education-entry .row {
            margin-bottom: 1rem;
        }
        
        .education-entry .form-control:focus,
        .education-entry .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        /* Custom file upload button */
        .custom-file-upload {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            background: var(--gradient-primary);
            color: white;
            border-radius: 0.75rem;
            transition: var(--transition);
            font-weight: 500;
            text-align: center;
        }
        
        .custom-file-upload:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.3);
        }
        
        /* Profile completion indicator */
        .profile-completion {
            margin-bottom: 2rem;
        }
        
        .completion-bar {
            height: 10px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
        }
        
        .completion-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* Section icons */
        .section-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(13, 110, 253, 0.1);
            border-radius: 50%;
            margin-right: 15px;
            color: var(--primary-color);
            font-size: 1.25rem;
        }
        
        /* Loading spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }
    </style>
</head>
<body>

<!-- header -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary fixed-top py-2">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="images/logo.png" alt="Hitaishi Careers Logo" height="40" class="me-2">
          <span class="fw-bold">Hitaishi Careers</span>
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
          <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="jobs.html">Jobs</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="servicesDropdown" role="button" data-bs-toggle="dropdown">
                Services
              </a>
              <ul class="dropdown-menu" aria-labelledby="servicesDropdown">
                <li><a class="dropdown-item" href="featuredprofile.html">Featured Profile</a></li>
                <li><a class="dropdown-item" href="featuredprofile.html">Profile Highlighter</a></li>
                <li><a class="dropdown-item" href="careerbooster.html">Career Booster</a></li>
                <li><a class="dropdown-item" href="resumebuild.html">Resume Writing</a></li>
                <li><a class="dropdown-item" href="resumebuild.html">Resume Builder</a></li>
                <li><a class="dropdown-item" href="network.html">LinkedIn Makeover</a></li>
                <li><a class="dropdown-item" href="preparation.html">Mock Interview</a></li>
                <li><a class="dropdown-item" href="preparation.html">Interview Preparation</a></li>
                <li><a class="dropdown-item" href="preparation.html">Skill Assessment</a></li>
                <li><a class="dropdown-item" href="preparation.html">Degree Programs</a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="employerlogin.html">Post Jobs</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="employer.html">Employers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="uploadResumeLink">Upload Resume</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="tutu.html">Apply with AI</a>
            </li>
          </ul>
          
          <!-- Profile / Avatar -->
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center" href="login.html" id="profileLink">
                <!-- Default Icon -->
                <i id="profile-icon" class="fas fa-user-circle fa-2x text-white"></i>
                <!-- User Avatar (hidden by default) -->
                <img id="profile-avatar" src="" alt="User Avatar"
                    class="rounded-circle d-none" width="40" height="40">
              </a>
            </li>
          </ul>

        </div>
      </div>
    </nav>
    <script>
        async function loadNavbarProfile() {
        const email = sessionStorage.getItem("email");
        if (!email) {
            console.log("User not logged in → showing default icon.");
            return;
        }

        try {
            // Call your backend to get profile
            const res = await fetch(`/api/profile/full?email=${encodeURIComponent(email)}`);
            if (!res.ok) {
            console.error("Failed to fetch profile:", res.status);
            return;
            }

            const data = await res.json();
            const profilePhoto = data.personalDetails?.profilePhoto;

            if (profilePhoto) {
            // Hide the default font-awesome icon
            document.getElementById("profile-icon").classList.add("d-none");

            // Show user's actual avatar
            const avatar = document.getElementById("profile-avatar");
            avatar.src = profilePhoto;
            avatar.classList.remove("d-none");
            }
        } catch (err) {
            console.error("Error loading navbar profile:", err);
        }
        }

        document.addEventListener("DOMContentLoaded", loadNavbarProfile);
    </script>

  </header>

    <div class="container my-4">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-lg-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Profile Sections</h5>
                        <nav class="nav nav-pills flex-column" id="profileNav">
                            <a class="nav-link active" href="#" data-section="personalDetails"><i class="bi bi-person me-2"></i>Personal Details</a>
                            <a class="nav-link" href="#" data-section="professionalDetails"><i class="bi bi-briefcase me-2"></i>Professional</a>
                            <a class="nav-link" href="#" data-section="projects"><i class="bi bi-folder me-2"></i>Projects</a>
                            <a class="nav-link" href="#" data-section="resume"><i class="bi bi-file-earmark me-2"></i>Resume</a>
                            <a class="nav-link" href="#" data-section="skills"><i class="bi bi-tools me-2"></i>Skills</a>
                            <a class="nav-link" href="#" data-section="education"><i class="bi bi-book me-2"></i>Education</a>
                            <a class="nav-link" href="#" data-section="certifications"><i class="bi bi-award me-2"></i>Certifications</a>
                            <a class="nav-link" href="#" data-section="languages"><i class="bi bi-translate me-2"></i>Languages</a>
                            <a class="nav-link" href="#" data-section="password"><i class="bi bi-shield-lock me-2"></i>Password</a>
                        </nav>
                    </div>
                </div>
                
                <!-- Profile Completion Card -->
                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Profile Completion</h5>
                        <div class="profile-completion">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Complete your profile</span>
                                <span id="completionPercentage">0%</span>
                            </div>
                            <div class="completion-bar">
                                <div class="completion-fill" id="completionFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="col-lg-9">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h1 class="mb-0 h4">My Profile</h1>
                    </div>
                    <div class="card-body">
                        <!-- Toast Container for Notifications -->
                        <div class="toast-container"></div>
                        
                        <!-- Loading Spinner -->
                        <div class="spinner-container d-none" id="loadingSpinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Personal Details Section -->
                        <div class="section-content active" id="personalDetails">
                            <div class="section-header">
                                <h2 class="h5 mb-0"><i class="bi bi-person me-2"></i>Personal Details</h2>
                                <button type="button" class="btn btn-outline-primary btn-sm edit-btn" onclick="toggleEdit('personalDetails', true)"><i class="bi bi-pencil me-1"></i> Edit</button>
                            </div>
                            <div id="personalDetailsView"></div>
                            <form id="personalDetailsForm" class="d-none">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fullName" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="fullName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" required readonly disabled>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="gender" class="form-label">Gender</label>
                                        <select class="form-select" id="gender">
                                            <option value="">Select Gender</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Experience Level</label>
                                        <div>
                                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="experienceLevel" id="fresher" value="fresher"><label class="form-check-label" for="fresher">Fresher</label></div>
                                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="experienceLevel" id="experienced" value="experienced"><label class="form-check-label" for="experienced">Experienced</label></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ctcExpected" class="form-label">CTC Expected (in LPA)</label>
                                        <input type="number" class="form-control" id="ctcExpected" min="0" step="0.1">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="profilePhoto" class="form-label">Profile Photo</label>
                                    <div class="d-flex align-items-center">
                                        <label for="profilePhoto" class="custom-file-upload me-3">
                                            <i class="bi bi-cloud-upload me-1"></i> Choose File
                                        </label>
                                        <input type="file" class="form-control d-none" id="profilePhoto" accept="image/*">
                                        <span id="profilePhotoName">No file chosen</span>
                                    </div>
                                    <div class="mt-3 text-center">
                                        <img id="profilePhotoPreview" src="https://placehold.co/150x150/EFEFEF/AAAAAA&text=Photo" alt="Profile Photo Preview" class="profile-photo-preview">
                                    </div>
                                </div>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary" onclick="savePersonalDetails()"><i class="bi bi-check-lg me-1"></i> Save</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleEdit('personalDetails', false)"><i class="bi bi-x-lg me-1"></i> Cancel</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Dynamic Sections (will be populated by JS) -->
                        <div class="section-content" id="professionalDetails"></div>
                        <div class="section-content" id="projects"></div>
                        <div class="section-content" id="resume"></div>
                        <div class="section-content" id="skills"></div>
                        <div class="section-content" id="education"></div>
                        <div class="section-content" id="certifications"></div>
                        <div class="section-content" id="languages"></div>

                        <!-- Change Password Section -->
                        <div class="section-content" id="password">
                            <div class="section-header">
                                <h2 class="h5 mb-0"><i class="bi bi-shield-lock me-2"></i>Change Password</h2>
                            </div>
                            <form id="changePasswordForm" onsubmit="event.preventDefault(); updatePassword();">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="newPassword" class="form-label">New Password</label>
                                        <input type="password" id="newPassword" class="form-control" minlength="6" required>
                                        <div class="form-text">Password must be at least 6 characters long.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                                        <input type="password" id="confirmPassword" class="form-control" minlength="6" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-key me-1"></i> Update Password</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global state
        let profileData = {};
        let nextEntryId = 1;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            setupNavigation();
            loadProfileData();
            setupEventListeners();
        });

        function setupNavigation() {
            document.querySelectorAll('#profileNav .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('#profileNav .nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.section-content').forEach(section => section.classList.remove('active'));
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                });
            });
        }
        
        function setupEventListeners() {
            document.getElementById('profilePhoto').addEventListener('change', e => {
                const file = e.target.files[0];
                document.getElementById('profilePhotoName').textContent = file ? file.name : 'No file chosen';
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => { document.getElementById('profilePhotoPreview').src = e.target.result; };
                    reader.readAsDataURL(file);
                }
            });
        }

        // --- Data Loading & Population ---
        async function loadProfileData() {
            try {
                showLoading(true);
                const email = sessionStorage.getItem("email");
                if (!email) {
                    console.warn("No email found in session storage. Please log in.");
                    showToast("Authentication error. Please log in again.", "danger");
                    showLoading(false);
                    return;
                }

                const response = await fetch(`/api/profile/full?email=${encodeURIComponent(email)}`);
                if (!response.ok) throw new Error("Failed to load profile data. Status: " + response.status);

                profileData = await response.json();
                populateAllSections();
                updateProfileCompletion();
                showLoading(false);
            } catch (error) {
                console.error("Error loading profile data:", error);
                showToast("Error loading your profile. Please try again.", "danger");
                showLoading(false);
            }
        }

        function populateAllSections() {
            populatePersonalDetails();
            renderDynamicSection('professionalDetails', 'Professional Details', profileData.professionalDetails, renderProfessionalView, 'addProfessionalEntry', 'saveProfessionalDetails');
            renderDynamicSection('projects', 'Projects', profileData.projects, renderProjectView, 'addProjectEntry', 'saveProjects');
            renderDynamicSection('skills', 'Skills', profileData.skills, renderSkillView, 'addSkillEntry', 'saveSkills');
            renderDynamicSection('education', 'Education', profileData.education, renderEducationView, 'addEducationEntry', 'saveEducation');
            renderDynamicSection('certifications', 'Certifications', profileData.certifications, renderCertificationView, 'addCertificationEntry', 'saveCertifications');
            renderDynamicSection('languages', 'Languages', profileData.languages, renderLanguageView, 'addLanguageEntry', 'saveLanguages');
            // Special handling for resume section
            renderResumeSection();
        }
        
        function populatePersonalDetails() {
            if (!profileData.personalDetails) return;
            const pd = profileData.personalDetails;
            
            // Populate View
            const viewContainer = document.getElementById('personalDetailsView');
            const na = '<span class="text-muted">N/A</span>';
            viewContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <img src="${pd.profilePhoto || 'https://placehold.co/150x150/EFEFEF/AAAAAA&text=Photo'}" class="profile-photo-preview" alt="Profile Photo">
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-sm-6 mb-2"><strong>Full Name:</strong><br> ${pd.fullName || na}</div>
                            <div class="col-sm-6 mb-2"><strong>Email:</strong><br> ${pd.email || na}</div>
                            <div class="col-sm-6 mb-2"><strong>Phone:</strong><br> ${pd.phone || na}</div>
                            <div class="col-sm-6 mb-2"><strong>Gender:</strong><br> ${pd.gender ? pd.gender.charAt(0).toUpperCase() + pd.gender.slice(1) : na}</div>
                            <div class="col-sm-6 mb-2"><strong>Experience:</strong><br> ${pd.experienceLevel ? pd.experienceLevel.charAt(0).toUpperCase() + pd.experienceLevel.slice(1) : na}</div>
                            <div class="col-sm-6 mb-2"><strong>Expected CTC:</strong><br> ${pd.ctcExpected ? `${pd.ctcExpected} LPA` : na}</div>
                        </div>
                    </div>
                </div>`;
            
            // Populate Form
            document.getElementById('fullName').value = pd.fullName || '';
            document.getElementById('email').value = pd.email || '';
            document.getElementById('phone').value = pd.phone || '';
            document.getElementById('gender').value = pd.gender || '';
            if (pd.experienceLevel) {
                const el = document.querySelector(`input[name="experienceLevel"][value="${pd.experienceLevel}"]`);
                if (el) el.checked = true;
            } else {
                 const el = document.querySelector(`input[name="experienceLevel"]:checked`);
                 if(el) el.checked = false;
            }
            document.getElementById('ctcExpected').value = pd.ctcExpected || '';
            document.getElementById('profilePhotoPreview').src = pd.profilePhoto || 'https://placehold.co/150x150/EFEFEF/AAAAAA&text=Photo';
        }

        // --- Generic Section Rendering ---
        function renderDynamicSection(id, title, data, renderViewFn, addEntryFnName, saveFnName) {
            const container = document.getElementById(id);
            let itemsHTML = data && data.length > 0 ? data.map(renderViewFn).join('') : `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>No information added yet.</p>
                    <button type="button" class="btn btn-outline-primary" onclick="toggleEdit('${id}', true)">Add Information</button>
                </div>`;
            
            container.innerHTML = `
                <div class="section-header">
                    <h2 class="h5 mb-0"><i class="bi ${getSectionIcon(id)} me-2"></i>${title}</h2>
                    <button type="button" class="btn btn-outline-primary btn-sm edit-btn" onclick="toggleEdit('${id}', true)"><i class="bi bi-pencil me-1"></i> Edit</button>
                </div>
                <div id="${id}View">
                    ${itemsHTML}
                </div>
                <form id="${id}Form" class="d-none">
                    <div id="${id}Entries"></div>
                    <button type="button" class="btn btn-outline-primary mb-3" onclick="${addEntryFnName}()">
                        <i class="bi bi-plus"></i> Add Entry
                    </button>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="${saveFnName}()"><i class="bi bi-check-lg me-1"></i> Save</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="toggleEdit('${id}', false)"><i class="bi bi-x-lg me-1"></i> Cancel</button>
                    </div>
                </form>
            `;
        }
        
        function renderResumeSection() {
            const container = document.getElementById('resume');
            const resumeData = profileData.resume || {};
            
            container.innerHTML = `
                <div class="section-header">
                    <h2 class="h5 mb-0"><i class="bi bi-file-earmark me-2"></i>Resume</h2>
                </div>
                <div id="resumeView">
                    ${resumeData.fileName ? `
                        <div class="resume-preview">
                            <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 2rem;"></i>
                            <div>
                                <h5>${resumeData.fileName}</h5>
                                <p class="text-muted mb-0">Uploaded on ${new Date(resumeData.uploadDate).toLocaleDateString()}</p>
                            </div>
                        </div>
                    ` : `
                        <div class="empty-state">
                            <i class="bi bi-file-earmark"></i>
                            <p>No resume uploaded yet.</p>
                        </div>
                    `}
                </div>
                <form id="resumeForm">
                    <div class="mb-3">
                        <label for="resumeFile" class="form-label">Upload Resume (PDF, DOC, DOCX)</label>
                        <div class="d-flex align-items-center">
                            <label for="resumeFile" class="custom-file-upload me-3">
                                <i class="bi bi-cloud-upload me-1"></i> Choose File
                            </label>
                            <input type="file" class="form-control d-none" id="resumeFile" accept=".pdf,.doc,.docx">
                            <span id="resumeFileName">No file chosen</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="saveResume()"><i class="bi bi-check-lg me-1"></i> Upload Resume</button>
                    </div>
                </form>
            `;
            
            document.getElementById('resumeFile').addEventListener('change', e => {
                const file = e.target.files[0];
                document.getElementById('resumeFileName').textContent = file ? file.name : 'No file chosen';
            });
        }

        // --- View Render Functions ---
        function renderProfessionalView(item) {
            return `
                <div class="view-section">
                    <h5>${item.jobTitle || 'N/A'}</h5>
                    <div class="row">
                        <div class="col-sm-6"><strong>Company:</strong> ${item.company || 'N/A'}</div>
                        <div class="col-sm-6"><strong>Location:</strong> ${item.location || 'N/A'}</div>
                        <div class="col-sm-6"><strong>Duration:</strong> ${item.startDate || 'N/A'} - ${item.currentJob ? 'Present' : (item.endDate || 'N/A')}</div>
                        <div class="col-sm-6"><strong>Current Job:</strong> ${item.currentJob ? 'Yes' : 'No'}</div>
                    </div>
                    <p class="mt-2"><strong>Description:</strong> ${item.description || 'N/A'}</p>
                </div>
            `;
        }

        function renderProjectView(item) {
            return `
                <div class="view-section">
                    <h5>${item.projectName || 'N/A'}</h5>
                    <div class="row">
                        <div class="col-sm-6"><strong>Technologies:</strong> ${item.technologies || 'N/A'}</div>
                        <div class="col-sm-6"><strong>Duration:</strong> ${item.startDate || 'N/A'} - ${item.endDate || 'N/A'}</div>
                    </div>
                    <p class="mt-2"><strong>Description:</strong> ${item.description || 'N/A'}</p>
                    <p><strong>Role:</strong> ${item.role || 'N/A'}</p>
                </div>
            `;
        }

        function renderSkillView(item) {
            return `
                <div class="view-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>${item.skillName || 'N/A'}</h5>
                        <span class="badge bg-primary">${item.proficiency || 'N/A'}/10</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: ${(item.proficiency || 0) * 10}%"></div>
                    </div>
                </div>
            `;
        }

        function renderEducationView(item) {
            return `
                <div class="view-section">
                    <h5>${item.degree || 'N/A'}</h5>
                    <div class="row">
                        <div class="col-sm-6"><strong>Institution:</strong> ${item.institution || 'N/A'}</div>
                        <div class="col-sm-6"><strong>Location:</strong> ${item.location || 'N/A'}</div>
                        <div class="col-sm-6"><strong>Duration:</strong> ${item.startYear || 'N/A'} - ${item.endYear || 'N/A'}</div>
                        <div class="col-sm-6"><strong>CGPA/Percentage:</strong> ${item.grade || 'N/A'}</div>
                    </div>
                </div>
            `;
        }

        function renderCertificationView(item) {
            return `
                <div class="view-section">
                    <h5>${item.certificationName || 'N/A'}</h5>
                    <div class="row">
                        <div class="col-sm-6"><strong>Issuing Organization:</strong> ${item.issuingOrganization || 'N/A'}</div>
                        <div class="col-sm-6"><strong>Date:</strong> ${item.issueDate || 'N/A'} ${item.expiryDate ? `- ${item.expiryDate}` : ''}</div>
                    </div>
                    <p class="mt-2"><strong>Credential ID:</strong> ${item.credentialId || 'N/A'}</p>
                </div>
            `;
        }

        function renderLanguageView(item) {
            return `
                <div class="view-section">
                    <h5>${item.language || 'N/A'}</h5>
                    <div class="row">
                        <div class="col-sm-6"><strong>Proficiency:</strong> ${item.proficiency || 'N/A'}</div>
                    </div>
                </div>
            `;
        }

        // --- Form Entry Functions ---
        function addProfessionalEntry() {
            const container = document.getElementById('professionalDetailsEntries');
            const id = nextEntryId++;
            container.innerHTML += `
                <div class="dynamic-section">
                    <button type="button" class="btn btn-sm remove-btn" onclick="removeEntry(this)"><i class="bi bi-x"></i></button>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Job Title</label>
                            <input type="text" class="form-control" name="jobTitle" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-control" name="company" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" name="location">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Duration</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="month" class="form-control" name="startDate" required>
                                </div>
                                <div class="col-6">
                                    <input type="month" class="form-control" name="endDate">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="currentJob" id="currentJob${id}">
                                <label class="form-check-label" for="currentJob${id}">Current Job</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </div>
            `;
        }

        function addProjectEntry() {
            const container = document.getElementById('projectsEntries');
            container.innerHTML += `
                <div class="dynamic-section">
                    <button type="button" class="btn btn-sm remove-btn" onclick="removeEntry(this)"><i class="bi bi-x"></i></button>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Project Name</label>
                            <input type="text" class="form-control" name="projectName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Technologies Used</label>
                            <input type="text" class="form-control" name="technologies">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Duration</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="month" class="form-control" name="startDate">
                                </div>
                                <div class="col-6">
                                    <input type="month" class="form-control" name="endDate">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Your Role</label>
                            <input type="text" class="form-control" name="role">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </div>
            `;
        }

        function addSkillEntry() {
            const container = document.getElementById('skillsEntries');
            const id = nextEntryId++;
            container.innerHTML += `
                <div class="dynamic-section">
                    <button type="button" class="btn btn-sm remove-btn" onclick="removeEntry(this)"><i class="bi bi-x"></i></button>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Skill Name</label>
                            <input type="text" class="form-control" name="skillName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Proficiency Level (1-10)</label>
                            <input type="range" class="form-range" name="proficiency" min="1" max="10" value="5" oninput="updateProficiencyValue(this, ${id})">
                            <div class="d-flex justify-content-between">
                                <small>Beginner</small>
                                <small id="proficiencyValue${id}">5</small>
                                <small>Expert</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function addEducationEntry() {
            const container = document.getElementById('educationEntries');
            container.innerHTML += `
                <div class="dynamic-section">
                    <button type="button" class="btn btn-sm remove-btn" onclick="removeEntry(this)"><i class="bi bi-x"></i></button>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Degree/Certificate</label>
                            <input type="text" class="form-control" name="degree" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Institution</label>
                            <input type="text" class="form-control" name="institution" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" name="location">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Duration</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control" name="startYear" placeholder="Start Year" min="1900" max="2099">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" name="endYear" placeholder="End Year" min="1900" max="2099">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CGPA/Percentage</label>
                            <input type="text" class="form-control" name="grade">
                        </div>
                    <div class="col-md-6 mb-3">
                            <label class="form-label">Field of Study</label>
                            <input type="text" class="form-control" name="fieldOfStudy">
                        </div>
                    </div>
                </div>
            `;
        }

        function addCertificationEntry() {
            const container = document.getElementById('certificationsEntries');
            container.innerHTML += `
                <div class="dynamic-section">
                    <button type="button" class="btn btn-sm remove-btn" onclick="removeEntry(this)"><i class="bi bi-x"></i></button>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Certification Name</label>
                            <input type="text" class="form-control" name="certificationName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Issuing Organization</label>
                            <input type="text" class="form-control" name="issuingOrganization" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Issue Date</label>
                            <input type="month" class="form-control" name="issueDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="month" class="form-control" name="expiryDate">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credential ID</label>
                        <input type="text" class="form-control" name="credentialId">
                    </div>
                </div>
            `;
        }

        function addLanguageEntry() {
            const container = document.getElementById('languagesEntries');
            container.innerHTML += `
                <div class="dynamic-section">
                    <button type="button" class="btn btn-sm remove-btn" onclick="removeEntry(this)"><i class="bi bi-x"></i></button>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Language</label>
                            <input type="text" class="form-control" name="language" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Proficiency</label>
                            <select class="form-select" name="proficiency">
                                <option value="">Select Proficiency</option>
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                                <option value="Native">Native</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Form Management ---
        function toggleEdit(sectionId, showForm) {
            const view = document.getElementById(sectionId + 'View');
            const form = document.getElementById(sectionId + 'Form');
            const editBtn = document.querySelector(`#${sectionId} .edit-btn`);
            
            if (showForm) {
                view.classList.add('d-none');
                form.classList.remove('d-none');
                editBtn.innerHTML = '<i class="bi bi-eye me-1"></i> View';
                editBtn.onclick = () => toggleEdit(sectionId, false);
                
                // Populate form with existing data
                populateForm(sectionId);
            } else {
                view.classList.remove('d-none');
                form.classList.add('d-none');
                editBtn.innerHTML = '<i class="bi bi-pencil me-1"></i> Edit';
                editBtn.onclick = () => toggleEdit(sectionId, true);
            }
        }

        function populateForm(sectionId) {
            const data = profileData[sectionId] || [];
            const entriesContainer = document.getElementById(sectionId + 'Entries');
            entriesContainer.innerHTML = '';
            
            if (data.length === 0) {
                // Add one empty entry if no data exists
                switch(sectionId) {
                    case 'professionalDetails': addProfessionalEntry(); break;
                    case 'projects': addProjectEntry(); break;
                    case 'skills': addSkillEntry(); break;
                    case 'education': addEducationEntry(); break;
                    case 'certifications': addCertificationEntry(); break;
                    case 'languages': addLanguageEntry(); break;
                }
            } else {
                // Add entries for each existing item
                data.forEach(item => {
                    switch(sectionId) {
                        case 'professionalDetails': addProfessionalEntry(); break;
                        case 'projects': addProjectEntry(); break;
                        case 'skills': addSkillEntry(); break;
                        case 'education': addEducationEntry(); break;
                        case 'certifications': addCertificationEntry(); break;
                        case 'languages': addLanguageEntry(); break;
                    }
                    
                    // Populate the last added entry with data
                    const lastEntry = entriesContainer.lastElementChild;
                    if (lastEntry) {
                        Object.keys(item).forEach(key => {
                            const input = lastEntry.querySelector(`[name="${key}"]`);
                            if (input) {
                                if (input.type === 'checkbox') {
                                    input.checked = item[key];
                                } else {
                                    input.value = item[key] || '';
                                }
                            }
                        });
                    }
                });
            }
        }

        function removeEntry(button) {
            const section = button.closest('.dynamic-section');
            if (section) {
                section.remove();
            }
        }

        // --- Save Functions ---
        async function savePersonalDetails() {
            try {
                showLoading(true);
                const formData = new FormData();
                const profilePhoto = document.getElementById('profilePhoto').files[0];
                
                if (profilePhoto) {
                    formData.append('profilePhoto', profilePhoto);
                }
                
                const personalDetails = {
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    gender: document.getElementById('gender').value,
                    experienceLevel: document.querySelector('input[name="experienceLevel"]:checked')?.value,
                    ctcExpected: document.getElementById('ctcExpected').value
                };
                
                formData.append('personalDetails', JSON.stringify(personalDetails));
                
                const response = await fetch('/api/profile/personal-details', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error("Failed to save personal details");
                
                showToast("Personal details saved successfully!", "success");
                toggleEdit('personalDetails', false);
                await loadProfileData(); // Reload to get updated photo URL
                showLoading(false);
            } catch (error) {
                console.error("Error saving personal details:", error);
                showToast("Error saving personal details. Please try again.", "danger");
                showLoading(false);
            }
        }

        async function saveProfessionalDetails() {
            const entries = collectFormData('professionalDetailsEntries');
            await saveSectionData('professional-details', entries, 'Professional details');
        }

        async function saveProjects() {
            const entries = collectFormData('projectsEntries');
            await saveSectionData('projects', entries, 'Projects');
        }

        async function saveSkills() {
            const entries = collectFormData('skillsEntries');
            await saveSectionData('skills', entries, 'Skills');
        }

        async function saveEducation() {
            const entries = collectFormData('educationEntries');
            await saveSectionData('education', entries, 'Education');
        }

        async function saveCertifications() {
            const entries = collectFormData('certificationsEntries');
            await saveSectionData('certifications', entries, 'Certifications');
        }

        async function saveLanguages() {
            const entries = collectFormData('languagesEntries');
            await saveSectionData('languages', entries, 'Languages');
        }

        async function saveResume() {
            try {
                showLoading(true);
                const resumeFile = document.getElementById('resumeFile').files[0];
                if (!resumeFile) {
                    showToast("Please select a file to upload.", "warning");
                    showLoading(false);
                    return;
                }
                
                const formData = new FormData();
                formData.append('resume', resumeFile);
                
                const response = await fetch('/api/profile/resume', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error("Failed to upload resume");
                
                showToast("Resume uploaded successfully!", "success");
                await loadProfileData();
                showLoading(false);
            } catch (error) {
                console.error("Error uploading resume:", error);
                showToast("Error uploading resume. Please try again.", "danger");
                showLoading(false);
            }
        }

        async function updatePassword() {
            try {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    showToast("Passwords do not match.", "danger");
                    return;
                }
                
                if (newPassword.length < 6) {
                    showToast("Password must be at least 6 characters long.", "danger");
                    return;
                }
                
                showLoading(true);
                const response = await fetch('/api/profile/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPassword })
                });
                
                if (!response.ok) throw new Error("Failed to update password");
                
                showToast("Password updated successfully!", "success");
                document.getElementById('changePasswordForm').reset();
                showLoading(false);
            } catch (error) {
                console.error("Error updating password:", error);
                showToast("Error updating password. Please try again.", "danger");
                showLoading(false);
            }
        }

        // --- Helper Functions ---
        function collectFormData(containerId) {
            const entries = [];
            const containers = document.querySelectorAll(`#${containerId} .dynamic-section`);
            
            containers.forEach(container => {
                const inputs = container.querySelectorAll('input, textarea, select');
                const entry = {};
                
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        entry[input.name] = input.checked;
                    } else if (input.type === 'file') {
                        // Skip file inputs in dynamic sections
                    } else {
                        entry[input.name] = input.value;
                    }
                });
                
                // Only add entry if it has at least one non-empty value
                if (Object.values(entry).some(val => val && val.toString().trim() !== '')) {
                    entries.push(entry);
                }
            });
            
            return entries;
        }

        async function saveSectionData(endpoint, data, sectionName) {
            try {
                showLoading(true);
                const response = await fetch(`/api/profile/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error(`Failed to save ${sectionName}`);
                
                showToast(`${sectionName} saved successfully!`, "success");
                toggleEdit(endpoint, false);
                await loadProfileData();
                showLoading(false);
            } catch (error) {
                console.error(`Error saving ${sectionName}:`, error);
                showToast(`Error saving ${sectionName}. Please try again.`, "danger");
                showLoading(false);
            }
        }

        function updateProficiencyValue(slider, id) {
            document.getElementById(`proficiencyValue${id}`).textContent = slider.value;
        }

        function getSectionIcon(sectionId) {
            const icons = {
                personalDetails: 'bi-person',
                professionalDetails: 'bi-briefcase',
                projects: 'bi-folder',
                resume: 'bi-file-earmark',
                skills: 'bi-tools',
                education: 'bi-book',
                certifications: 'bi-award',
                languages: 'bi-translate',
                password: 'bi-shield-lock'
            };
            return icons[sectionId] || 'bi-gear';
        }

        function updateProfileCompletion() {
            let completedFields = 0;
            let totalFields = 0;
            
            // Personal Details
            if (profileData.personalDetails) {
                const pd = profileData.personalDetails;
                totalFields += 6;
                if (pd.fullName) completedFields++;
                if (pd.email) completedFields++;
                if (pd.phone) completedFields++;
                if (pd.gender) completedFields++;
                if (pd.experienceLevel) completedFields++;
                if (pd.ctcExpected) completedFields++;
            }
            
            // Other sections
            const sections = ['professionalDetails', 'projects', 'skills', 'education', 'certifications', 'languages', 'resume'];
            sections.forEach(section => {
                if (profileData[section] && profileData[section].length > 0) {
                    completedFields += 2; // Each section with at least one entry counts as 2 fields
                    totalFields += 2;
                } else {
                    totalFields += 2;
                }
            });
            
            const percentage = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;
            document.getElementById('completionPercentage').textContent = `${percentage}%`;
            document.getElementById('completionFill').style.width = `${percentage}%`;
        }

        function showToast(message, type) {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
            bsToast.show();
            
            // Remove toast from DOM after it's hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('d-none');
            } else {
                spinner.classList.add('d-none');
            }
        }
    </script>
</body>
</html>